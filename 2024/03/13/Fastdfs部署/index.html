<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Fastdfs实战 | Shawshank-c</title><meta name="author" content="Shawshank-c"><meta name="copyright" content="Shawshank-c"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="docker 安装Fastdfs1.安装FastDFS1.1 镜像下载docker pull delron&#x2F;fastdfs 1.2 创建目录1234567cd &#x2F;dev1mkdir fastdfs mkdir tracker storagecd &#x2F;dev2 mkdir fastfdsmkdir storage  1.3 开启tracker容器docker run -d --restart&#x3D;alwa">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastdfs实战">
<meta property="og:url" content="http://example.com/2024/03/13/Fastdfs%E9%83%A8%E7%BD%B2/index.html">
<meta property="og:site_name" content="Shawshank-c">
<meta property="og:description" content="docker 安装Fastdfs1.安装FastDFS1.1 镜像下载docker pull delron&#x2F;fastdfs 1.2 创建目录1234567cd &#x2F;dev1mkdir fastdfs mkdir tracker storagecd &#x2F;dev2 mkdir fastfdsmkdir storage  1.3 开启tracker容器docker run -d --restart&#x3D;alwa">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png">
<meta property="article:published_time" content="2024-03-13T05:26:56.000Z">
<meta property="article:modified_time" content="2024-03-13T06:05:27.016Z">
<meta property="article:author" content="Shawshank-c">
<meta property="article:tag" content="路漫漫其修远兮">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/03/13/Fastdfs%E9%83%A8%E7%BD%B2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Fastdfs实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-13 14:05:27'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://shuichang.oss-cn-beijing.aliyuncs.com/A401B334-D883-4704-8016-2B664F7B9C62.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Shawshank-c"><span class="site-name">Shawshank-c</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Fastdfs实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-13T05:26:56.000Z" title="发表于 2024-03-13 13:26:56">2024-03-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-13T06:05:27.016Z" title="更新于 2024-03-13 14:05:27">2024-03-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Fastdfs实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="docker-安装Fastdfs"><a href="#docker-安装Fastdfs" class="headerlink" title="docker 安装Fastdfs"></a>docker 安装Fastdfs</h2><h3 id="1-安装FastDFS"><a href="#1-安装FastDFS" class="headerlink" title="1.安装FastDFS"></a>1.安装FastDFS</h3><h4 id="1-1-镜像下载"><a href="#1-1-镜像下载" class="headerlink" title="1.1 镜像下载"></a>1.1 镜像下载</h4><p><code>docker pull delron/fastdfs</code></p>
<h4 id="1-2-创建目录"><a href="#1-2-创建目录" class="headerlink" title="1.2 创建目录"></a>1.2 创建目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /dev1</span><br><span class="line">mkdir fastdfs </span><br><span class="line">mkdir tracker storage</span><br><span class="line"></span><br><span class="line">cd /dev2 </span><br><span class="line">mkdir fastfds</span><br><span class="line">mkdir storage</span><br></pre></td></tr></table></figure>

<h4 id="1-3-开启tracker容器"><a href="#1-3-开启tracker容器" class="headerlink" title="1.3 开启tracker容器"></a>1.3 开启tracker容器</h4><p><code>docker run -d --restart=always --network=host \ -v /dev1/fastdfs/tracker:/var/fdfs \ --name tracker delron/fastdfs tracker</code></p>
<h4 id="1-4-开启storage容器"><a href="#1-4-开启storage容器" class="headerlink" title="1.4 开启storage容器"></a>1.4 开启storage容器</h4><p><code>docker run -id --name storage2 --restart=always --net host -v /etc/localtime:/etc/localtime -v /dev1/fastdfs/storage:/var/fdfs -v /dev2/fastdfs/storage:/var/fdfs2 -e GROUP_NAME=&quot;group2&quot;  -e TRACKER_SERVER=&quot;172.16.5.1:22122&quot; delron/fastdfs  storage</code></p>
<h3 id="2-FastDFS集成Nginx-lua-GraphicMagick"><a href="#2-FastDFS集成Nginx-lua-GraphicMagick" class="headerlink" title="2. FastDFS集成Nginx+lua+GraphicMagick"></a>2. FastDFS集成Nginx+lua+GraphicMagick</h3><h4 id="2-1-依赖下载"><a href="#2-1-依赖下载" class="headerlink" title="2.1 依赖下载"></a>2.1 依赖下载</h4><p>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1bRSK240OAIM5WbC0VZ6e7Q">https://pan.baidu.com/s/1bRSK240OAIM5WbC0VZ6e7Q</a> 密码: mm6f</p>
<p>下载依赖包，上传到服务器中</p>
<h4 id="2-2-安装软件基础包"><a href="#2-2-安装软件基础包" class="headerlink" title="2.2 安装软件基础包"></a>2.2 安装软件基础包</h4><p>拷贝依赖包到docker容器中</p>
<p><code>docker cp /opt/src_v2.0.zip</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 进入storage容器</span><br><span class="line">docker exec -it storage /bin/bash</span><br><span class="line"></span><br><span class="line">yum install -y gcc gcc-c++ zlib zlib-devel openssl openssl-devel pcre pcre-devel gd-devel</span><br><span class="line">yum install -y libpng libjpeg libpng-devel libjpeg-devel ghostscript libtiff libtiff-devel freetype freetype-devel readline-devel ncurses-devel</span><br></pre></td></tr></table></figure>

<h3 id="2-3-依赖安装"><a href="#2-3-依赖安装" class="headerlink" title="2.3 依赖安装"></a>2.3 依赖安装</h3><ol>
<li>解压</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">unzip src_v2.0.zip</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装LuaJIT</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/LuaJIT-2.0.4</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">export LUAJIT_LIB=/usr/local/lib</span><br><span class="line">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line">ln -s /usr/local/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装Lua</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/lua-5.3.1</span><br><span class="line">make linux &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装GM</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/GraphicsMagick-1.3.18</span><br><span class="line">./configure --prefix=/usr/local/GraphicsMagick-1.3.18 --enable-shared</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -s /usr/local/GraphicsMagick-1.3.18 /usr/local/GraphicsMagick</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装nginx</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 停止Nginx服务</span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"># 进入Nginx目录</span><br><span class="line">cd /tmp/nginx/nginx-1.12.2</span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--add-module=/usr/local/src/fastdfs-nginx-module-master/src \</span><br><span class="line">--with-pcre \</span><br><span class="line">--add-module=/usr/local/src/lua-nginx-module-0.10.9rc7 \</span><br><span class="line">--add-module=/usr/local/src/ngx_devel_kit \</span><br><span class="line">--with-stream</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>



<h4 id="2-4-修改nginx-conf配置"><a href="#2-4-修改nginx-conf配置" class="headerlink" title="2.4 修改nginx.conf配置"></a>2.4 修改nginx.conf配置</h4><p><code># 编辑nginx.conf vi /usr/local/nginx/conf/nginx.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line"><span class="attribute">set</span> <span class="variable">$img_thumbnail_root</span> /var/fdfs/thumb; <span class="comment">#缩略图保存的根目录</span></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$img_file</span> <span class="variable">$img_thumbnail_root</span><span class="variable">$uri</span>;   <span class="comment">#缩略图路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># like：/xx/xx/xx.jpg_100-.jpg or /xx/xx/xx.jpg_-100.jpg</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* ^(\/(\w+)(\/M00)(.+\.(jpg|jpeg|gif|png)))_((\d+\-)|(\-\d+))\.(jpg|jpeg|gif|png)$</span> &#123;</span><br><span class="line">  <span class="attribute">root</span> <span class="variable">$img_thumbnail_root</span>;    <span class="comment"># root path for croped img</span></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$fdfs_group_root</span> /var/fdfs/data; <span class="comment">#图片存放目录</span></span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$img_file</span>) &#123;    <span class="comment"># if thumb file not exists</span></span><br><span class="line">            <span class="attribute">add_header</span> X-Powered-By <span class="string">&#x27;Nginx+Lua+GraphicsMagick By Yanue&#x27;</span>;  <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">add_header</span> file-path <span class="variable">$request_filename</span>;    <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$request_filepath</span> <span class="variable">$fdfs_group_root</span><span class="variable">$4</span>;    <span class="comment"># origin_img full path：/document_root/1.gif</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_size</span> <span class="variable">$6</span>;    <span class="comment"># img width or height size depends on uri : img size like &quot;-100&quot; or &quot;100-&quot;, &quot;-&quot; means auto size</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_ext</span> <span class="variable">$5</span>;    <span class="comment"># file ext</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /usr/local/src/lua/autoSize.lua;    <span class="comment"># load auto width or height crop Lua file</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># like：/pic/M00/xx/xx/xx.jpg_200x100.jpg</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* ^(\/(\w+)(\/M00)(.+\.(jpg|jpeg|gif|png))_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png))$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> <span class="variable">$img_thumbnail_root</span>;    <span class="comment"># root path for croped img</span></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$fdfs_group_root</span> /var/fdfs/data; <span class="comment">#set fastdfs group path $2</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$img_file</span>) &#123;   <span class="comment"># if thumb file not exists</span></span><br><span class="line">            <span class="attribute">add_header</span> X-Powered-By <span class="string">&#x27;Nginx+Lua+GraphicsMagick By Yanue&#x27;</span>;  <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">add_header</span> file-path <span class="variable">$request_filename</span>;    <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$request_filepath</span> <span class="variable">$fdfs_group_root</span><span class="variable">$4</span>;    <span class="comment"># real file path</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_width</span> <span class="variable">$6</span>;    <span class="comment">#  img width</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_height</span> <span class="variable">$7</span>;    <span class="comment">#  img height</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_ext</span> <span class="variable">$5</span>;     <span class="comment"># file ext</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /usr/local/src/lua/cropSize.lua;    <span class="comment"># load crop Lua file</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#========分割线========</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* ^(\/(\w+)(\/M01)(.+\.(jpg|jpeg|gif|png)))_((\d+\-)|(\-\d+))\.(jpg|jpeg|gif|png)$</span> &#123;</span><br><span class="line">  <span class="attribute">root</span> <span class="variable">$img_thumbnail_root</span>;    <span class="comment"># root path for croped img</span></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$fdfs_group_root</span> /var/fdfs2/data; <span class="comment">#图片存放目录</span></span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$img_file</span>) &#123;    <span class="comment"># if thumb file not exists</span></span><br><span class="line">            <span class="attribute">add_header</span> X-Powered-By <span class="string">&#x27;Nginx+Lua+GraphicsMagick By Yanue&#x27;</span>;  <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">add_header</span> file-path <span class="variable">$request_filename</span>;    <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$request_filepath</span> <span class="variable">$fdfs_group_root</span><span class="variable">$4</span>;    <span class="comment"># origin_img full path：/document_root/1.gif</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_size</span> <span class="variable">$6</span>;    <span class="comment"># img width or height size depends on uri : img size like &quot;-100&quot; or &quot;100-&quot;, &quot;-&quot; means auto size</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_ext</span> <span class="variable">$5</span>;    <span class="comment"># file ext</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /usr/local/src/lua/autoSize.lua;    <span class="comment"># load auto width or height crop Lua file</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># like：/pic/M01/xx/xx/xx.jpg_200x100.jpg</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* ^(\/(\w+)(\/M00)(.+\.(jpg|jpeg|gif|png))_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png))$</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> <span class="variable">$img_thumbnail_root</span>;    <span class="comment"># root path for croped img</span></span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$fdfs_group_root</span> /var/fdfs2/data; <span class="comment">#set fastdfs group path $2</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$img_file</span>) &#123;   <span class="comment"># if thumb file not exists</span></span><br><span class="line">            <span class="attribute">add_header</span> X-Powered-By <span class="string">&#x27;Nginx+Lua+GraphicsMagick By Yanue&#x27;</span>;  <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">add_header</span> file-path <span class="variable">$request_filename</span>;    <span class="comment">#  header for test</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$request_filepath</span> <span class="variable">$fdfs_group_root</span><span class="variable">$4</span>;    <span class="comment"># real file path</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_width</span> <span class="variable">$6</span>;    <span class="comment">#  img width</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_height</span> <span class="variable">$7</span>;    <span class="comment">#  img height</span></span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$img_ext</span> <span class="variable">$5</span>;     <span class="comment"># file ext</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /usr/local/src/lua/cropSize.lua;    <span class="comment"># load crop Lua file</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> ~/group[<span class="number">0</span>-<span class="number">9</span>]/M00 &#123;</span><br><span class="line">		<span class="attribute">root</span> /var/fdfs/data</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> ~/group[<span class="number">0</span>-<span class="number">9</span>]/M01 &#123;</span><br><span class="line">		<span class="attribute">root</span> /var/fdfs2/data</span><br><span class="line">    ngx_fastdfs_module;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /favicon.ico &#123;</span><br><span class="line">    <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Storage配置多路径"><a href="#3-Storage配置多路径" class="headerlink" title="3. Storage配置多路径"></a>3. Storage配置多路径</h3><h4 id="3-1-修改-storage-conf"><a href="#3-1-修改-storage-conf" class="headerlink" title="3.1 修改 storage.conf"></a>3.1 修改 storage.conf</h4><p><code>vi /etc/storage.conf</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># path(disk or mount point) count, default value is 1</span><br><span class="line">store_path_count=2</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0 not exists, it&#x27;s value is base_path</span><br><span class="line"># the paths must be exist</span><br><span class="line">store_path0=/var/fdfs</span><br><span class="line">store_path1=/var/fdfs2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-2-修改mod-fastdfs-conf"><a href="#3-2-修改mod-fastdfs-conf" class="headerlink" title="3.2 修改mod_fastdfs.conf"></a>3.2 修改mod_fastdfs.conf</h4><p><code>需要修改两处 修改配置后需要重启storage容器</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># path(disk or mount point) count, default value is 1</span><br><span class="line"># must same as storage.conf</span><br><span class="line">store_path_count=2</span><br><span class="line"></span><br><span class="line"># store_path#, based 0, if store_path0=/var/fdfs</span><br><span class="line"># the paths must be exist</span><br><span class="line"># must same as storage.conf</span><br><span class="line">store_path0=/var/fdfs</span><br><span class="line">store_path1=/var/fdfs2</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"># group settings for group #1</span><br><span class="line"># since v1.14</span><br><span class="line"># when support multi-group on this storage server, uncomment following section</span><br><span class="line">[group1]</span><br><span class="line">group_name=group1</span><br><span class="line">storage_server_port=23000</span><br><span class="line">store_path_count=2</span><br><span class="line">store_path0=/var/fdfs</span><br><span class="line">store_path1=/var/fdfs2</span><br></pre></td></tr></table></figure>

<h3 id="4-配置多存储节点-storage"><a href="#4-配置多存储节点-storage" class="headerlink" title="4. 配置多存储节点(storage)"></a>4. 配置多存储节点(storage)</h3><h4 id="4-1-启动容器"><a href="#4-1-启动容器" class="headerlink" title="4.1 启动容器"></a>4.1 启动容器</h4><p><code>启动两个storage 每个节点负责挂载不同的目录（我司文件服务器上有两个盘分别是 dev1、dev2），上面我是在一个存储节点配置多路径</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name storage1 --restart=always --net host -v /etc/localtime:/etc/localtime -v /dev1/fastdfs/storage:/var/fdfs  -e GROUP_NAME=&quot;group1&quot;  -e TRACKER_SERVER=&quot;172.16.5.1:22122&quot; delron/fastdfs  storage</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name storage2 --restart=always --net host -v /etc/localtime:/etc/localtime -v /dev2/fastdfs/storage:/var/fdfs  -e GROUP_NAME=&quot;group2&quot;  -e TRACKER_SERVER=&quot;172.16.5.1:22122&quot; delron/fastdfs  storage</span><br></pre></td></tr></table></figure>

<h4 id="4-2-修改-storage1-mod-fastdfs-conf"><a href="#4-2-修改-storage1-mod-fastdfs-conf" class="headerlink" title="4.2 修改 storage1 mod_fastdfs.conf&#96;"></a>4.2 修改 storage1 mod_fastdfs.conf&#96;</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it storage1 /bin/bash</span><br><span class="line">vi /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"></span><br><span class="line"># the group name of the local storage server</span><br><span class="line">group_name=group1/group2</span><br><span class="line">tracker_server=172.16.5.1:22122</span><br><span class="line"></span><br><span class="line">group_count = 2</span><br><span class="line"></span><br><span class="line"># group settings for group #1</span><br><span class="line"># since v1.14</span><br><span class="line"># when support multi-group on this storage server, uncomment following section</span><br><span class="line">[group1]</span><br><span class="line">group_name=group1</span><br><span class="line">storage_server_port=23000</span><br><span class="line">store_path_count=2</span><br><span class="line">store_path0=/var/fdfs</span><br><span class="line"></span><br><span class="line"># group settings for group #2</span><br><span class="line"># since v1.14</span><br><span class="line"># when support multi-group, uncomment following section as neccessary</span><br><span class="line">[group2]</span><br><span class="line">group_name=group2</span><br><span class="line">storage_server_port=23001</span><br><span class="line">store_path_count=1</span><br><span class="line">store_path0=/var/fdfs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-3-修改-storage2-storage-conf"><a href="#4-3-修改-storage2-storage-conf" class="headerlink" title="4.3 修改 storage2 storage.conf"></a>4.3 修改 storage2 storage.conf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exce -it storage2 /bin/bash</span><br><span class="line">vi /etc/fdfs/storage.conf</span><br><span class="line"></span><br><span class="line">group_name=group2</span><br><span class="line">port=23001</span><br><span class="line">tracker_server=172.16.5.1:22122</span><br></pre></td></tr></table></figure>



<blockquote>
<p>delron&#x2F;fastdfs 镜像自带nginx  访问端口是8888 </p>
<p>修改nginx配置文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /image &#123;</span><br><span class="line">   <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">   <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">   <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;accesstoken,*&#x27;</span>;</span><br><span class="line">   <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">   <span class="attribute">add_header</span> Access-Control-Max-Age <span class="string">&quot;3600&quot;</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Real_IP <span class="variable">$remote_addr</span>;</span><br><span class="line">   <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">   <span class="attribute">proxy_pass</span> http://localhost:8888/;</span><br></pre></td></tr></table></figure>
<p>  }</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://xxx.com/image/group1/M01/00/01/rBAFAWNIuIWEFWkLAAAAALVgA-Q141.png">https://xxx.com/image/group1/M01/00/01/rBAFAWNIuIWEFWkLAAAAALVgA-Q141.png</a></p>
<p><a target="_blank" rel="noopener" href="https://xxx.com/image/group1/M01/00/01/rBAFAWNIuIWEFWkLAAAAALVgA-Q141.png_-200.png">https://xxx.com/image/group1/M01/00/01/rBAFAWNIuIWEFWkLAAAAALVgA-Q141.png_-200.png</a> </p>
</blockquote>
<h3 id="5-修改storage节点线程处理数"><a href="#5-修改storage节点线程处理数" class="headerlink" title="5. 修改storage节点线程处理数"></a>5. 修改storage节点线程处理数</h3><p><code>多客户端连接上传文件，会出现异常处理（客户端连接服务端出现了io异常:socket io exception occured while receive content）不支持单文件分片并发上传</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">accept thread count</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default value is 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">since V4.07</span></span><br><span class="line">accept_threads=4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">work thread count, should &lt;= max_connections</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">work thread deal network io</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default value is 4</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">since V2.00</span></span><br><span class="line">work_threads=20</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> disk <span class="built_in">read</span> / write separated</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  false for mixed read and write</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  true for separated read and write</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default value is <span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">since V2.00</span></span><br><span class="line">disk_rw_separated = true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disk reader thread count per store base path</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> mixed <span class="built_in">read</span> / write, this parameter can be 0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default value is 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">since V2.00</span></span><br><span class="line">disk_reader_threads = 4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disk writer thread count per store base path</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> mixed <span class="built_in">read</span> / write, this parameter can be 0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">default value is 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">since V2.00</span></span><br><span class="line">disk_writer_threads = 4</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6-解决文件访问权限"><a href="#6-解决文件访问权限" class="headerlink" title="6.解决文件访问权限"></a>6.解决文件访问权限</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 解决文件访问权限问题（访问文件不登录就能预览）</span><br><span class="line">* 1、把文件地址 &amp; 用户当前IP两个参数加密，请求到nginx时，获取到当前参数，再进行解密。</span><br><span class="line">* 2、获取解密的参数，解密参数中IP == 当前请求的ip =》放行</span><br><span class="line">* 3、否则401</span><br><span class="line">文件和图片只能在规定的网站上显示 referers</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHost</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> ngx.var.host</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUri</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">return</span> ngx.var.uri</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUUID</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">arg</span> = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">arg</span>) <span class="keyword">do</span></span><br><span class="line">   <span class="keyword">if</span> k == <span class="string">&#x27;uuid&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPreviewUrl</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">arg</span> = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">arg</span>) <span class="keyword">do</span></span><br><span class="line">   <span class="keyword">if</span> k == <span class="string">&#x27;url&#x27;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">token_filter</span><span class="params">(httpc, uuid, ClientIP,host,url,uri)</span></span></span><br><span class="line">	<span class="keyword">local</span> start = <span class="built_in">string</span>.<span class="built_in">match</span>(uri,<span class="string">&#x27;%/js&#x27;</span>)</span><br><span class="line">	<span class="keyword">local</span> start2 = <span class="built_in">string</span>.<span class="built_in">match</span>(uri,<span class="string">&#x27;%/css&#x27;</span>)</span><br><span class="line">	<span class="keyword">local</span> start3 = <span class="built_in">string</span>.<span class="built_in">match</span>(uri,<span class="string">&#x27;%/images&#x27;</span>)</span><br><span class="line">	ngx.<span class="built_in">log</span>(ngx.ERR,uri)</span><br><span class="line">	<span class="keyword">if</span> uuid == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">	  <span class="keyword">if</span> (start ~= <span class="literal">nil</span> <span class="keyword">or</span> start2 ~= <span class="literal">nil</span> <span class="keyword">or</span> start3 ~= <span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">	    	<span class="keyword">return</span> <span class="literal">true</span>	</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">end</span>      	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">local</span> req_para = &#123;&#125;</span><br><span class="line">  	<span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span></span><br><span class="line">	<span class="comment">--/session/validatetma认证接口中设置的token字段为id，所以这里将token放入json的属性是id</span></span><br><span class="line">	req_para[<span class="string">&quot;uuid&quot;</span>] = uuid</span><br><span class="line">	req_body = cjson.encode(req_para)</span><br><span class="line"></span><br><span class="line">	<span class="comment">--ngx.log(ngx.ERR,req_body)</span></span><br><span class="line">	<span class="comment">-- 发起对认证服务接口的调用，</span></span><br><span class="line">	<span class="keyword">local</span> resp,err = httpc:request_uri(<span class="string">&quot;http://127.0.0.1:8000/netdisk-common/encryptStr&quot;</span>,</span><br><span class="line">    	&#123;</span><br><span class="line">  	    ssl_verify = <span class="literal">false</span>,</span><br><span class="line"> 	    method = <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">   	        <span class="comment">--请求参数，包含了客户端请求token</span></span><br><span class="line">    	    body = req_body,</span><br><span class="line">    	    headers = &#123;</span><br><span class="line">            [<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;Accept&quot;</span>] = <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">            [<span class="string">&quot;Host&quot;</span>] = host,</span><br><span class="line">            [<span class="string">&quot;Content-Length&quot;</span>] = #req_body</span><br><span class="line">        &#125;</span><br><span class="line">  	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">--请求相应为空，返回false，校验不通过，这种情况可能有多种，调用接口失败或者其他原因需要具体分析</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">--请求接口成功</span></span><br><span class="line">	<span class="keyword">local</span> resp_body = cjson.decode(resp.body)</span><br><span class="line">	ngx.<span class="built_in">log</span>(ngx.ERR,ClientIP )</span><br><span class="line">	<span class="comment">--ngx.log(ngx.ERR,resp_body.data.url)</span></span><br><span class="line">	<span class="comment">--ngx.log(ngx.ERR,url)</span></span><br><span class="line">	<span class="keyword">if</span> resp_body.code == <span class="number">200</span> <span class="keyword">then</span></span><br><span class="line"> 		<span class="comment">--校验成功返回true，放行</span></span><br><span class="line">        <span class="keyword">if</span> (resp_body.data.ip == ClientIP ) <span class="keyword">then</span></span><br><span class="line">	   	 <span class="keyword">return</span> <span class="literal">true</span>       </span><br><span class="line">	   <span class="keyword">else</span></span><br><span class="line">	   	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	   <span class="keyword">end</span> 		</span><br><span class="line">  	<span class="keyword">else</span> </span><br><span class="line">  	   <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  	<span class="keyword">end</span>	</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----- main lua被调用后从这里开始执行----</span></span><br><span class="line"><span class="comment">--引入必要的lua库，完成http请求，我这里是lua脚本获取到客户端token后通过调用token认证服务完成token校验的</span></span><br><span class="line"><span class="comment">--这只是其中的一种方案，如果token存在数据库或者redis中也可以引入对应的库lua直接调用数据库或redis完整认证</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">&#x27;resty.http&#x27;</span></span><br><span class="line"><span class="keyword">local</span> httpc = http:new()</span><br><span class="line"><span class="comment">--ngx.log(ngx.ERR,&quot;-------------------- token_filter---------------&quot;)</span></span><br><span class="line"><span class="comment">--获取客户端请求的token，客户端的toekn存放在请求header的token属性</span></span><br><span class="line"><span class="keyword">local</span> uuid = getUUID()</span><br><span class="line"><span class="keyword">local</span> previewUrl = getPreviewUrl()</span><br><span class="line"><span class="keyword">local</span> uri =getUri()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--请求的host</span></span><br><span class="line"><span class="keyword">local</span> host = getHost()</span><br><span class="line"><span class="keyword">local</span> headers=ngx.req.get_headers()</span><br><span class="line"><span class="keyword">local</span> ClientIP=headers[<span class="string">&quot;X-REAL-IP&quot;</span>] <span class="keyword">or</span> headers[<span class="string">&quot;X_FORWARDED_FOR&quot;</span>] <span class="keyword">or</span> ngx.var.remote_addr <span class="keyword">or</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> flag = token_filter(httpc, uuid, ClientIP,host,ur,uri)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> flag == <span class="literal">false</span> <span class="keyword">then</span>	</span><br><span class="line">	httpc:<span class="built_in">close</span>()</span><br><span class="line">	ngx.<span class="built_in">exit</span>(<span class="number">401</span>)	</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  cloud-disk.lelepen.com;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">4096m</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">                  <span class="attribute">root</span> /data/admin-client/dist/;</span><br><span class="line">                  <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="section">location</span> /api &#123;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;accesstoken,*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> Access-Control-Max-Age <span class="string">&quot;3600&quot;</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Real_IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       <span class="attribute">proxy_pass</span> http://localhost:8000/;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="section">location</span> /image &#123;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;accesstoken,*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> Access-Control-Max-Age <span class="string">&quot;3600&quot;</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Real_IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       <span class="attribute">proxy_pass</span> http://localhost:8888/;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">location</span> /preview_file &#123;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;accesstoken,*&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">       <span class="attribute">add_header</span> Access-Control-Max-Age <span class="string">&quot;3600&quot;</span>;</span><br><span class="line">       <span class="attribute">access_by_lua_file</span> <span class="variable">$router</span> /etc/nginx/conf.d/lua/preview_file_filter.lua;	</span><br><span class="line">       <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Real_IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       <span class="attribute">proxy_pass</span> http://localhost:8012/;</span><br><span class="line">   &#125;	 </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>分片上传问题</p>
<ol>
<li>socket io exception occured while sending cmd</li>
</ol>
<blockquote>
<p>经过慢慢琢磨，和fastdfs-client作者沟通发现，是因为偏移量的问题。另外目前fastdfs只支持多文件并发，单不支持单文件的分块并发。</p>
</blockquote>
<ol start="2">
<li><strong>上传文件出现 java.nio.file.FileSystemException: &#x2F;opt&#x2F;temp&#x2F;cloud-disk&#x2F;undertow6523975979015572978upload: 打开的文件过多</strong></li>
</ol>
<p>向fastdfs作者提问或搜索问题：</p>
<p>![image-20230418093842242](&#x2F;Users&#x2F;chensihao&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20230418093842242.png)</p>
<p>从代码层面排查出问题发现确实没有关闭</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置Nginx将请求转发到MinIO</span></span><br><span class="line"><span class="section">location</span> /minio/ &#123;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:9000/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Nginx生成缩略图</span></span><br><span class="line"><span class="section">location</span> /thumbnails/ &#123;</span><br><span class="line">    <span class="comment"># 原始图片存储路径</span></span><br><span class="line">    <span class="attribute">root</span> /var/www/images;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 缩略图存储路径</span></span><br><span class="line">    <span class="attribute">alias</span> /var/www/thumbnails;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 图片缓存</span></span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /var/cache/nginx levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">10m</span> inactive=<span class="number">60m</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_key</span> <span class="string">&quot;<span class="variable">$scheme</span><span class="variable">$request_method</span><span class="variable">$host</span><span class="variable">$request_uri</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 支持的图片格式</span></span><br><span class="line">    <span class="attribute">image_filter_jpeg_quality</span> <span class="number">75</span>;</span><br><span class="line">    <span class="attribute">image_filter_buffer</span> <span class="number">20M</span>;</span><br><span class="line">    <span class="attribute">image_filter</span> resize <span class="number">300</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 请求缩略图时，检查缓存并在缓存中使用缩略图（如果存在）</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_filename</span> <span class="regexp">~* (.+)\.(jpg|jpeg|png|gif)$)</span> &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$image_file</span> <span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$image_extension</span> <span class="variable">$2</span>;</span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$http_accept</span> <span class="regexp">~* &#x27;webp&#x27;)</span> &#123;</span><br><span class="line">            <span class="attribute">set</span> <span class="variable">$image_extension</span> <span class="string">&#x27;.webp&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$resized_file</span> <span class="variable">$image_file</span>-<span class="variable">$arg_w</span>-<span class="variable">$arg_h</span><span class="variable">$arg_crop</span>.<span class="variable">$image_extension</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_key</span> <span class="string">&quot;<span class="variable">$scheme</span><span class="variable">$request_method</span><span class="variable">$host</span>/<span class="variable">$resized_file</span>&quot;</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_pragma</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_revalidate</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_valid</span> <span class="number">60m</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_lock</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_lock_age</span> <span class="number">5s</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> timeout updating http_500 http_503 http_404;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查是否存在已经生成的缩略图</span></span><br><span class="line">        <span class="attribute">if</span> (-f <span class="variable">$request_filename</span>-<span class="variable">$arg_w</span>-<span class="variable">$arg_h</span><span class="variable">$arg_crop</span>.<span class="variable">$image_extension</span>) &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^</span> /<span class="variable">$resized_file</span> <span class="literal">break</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_key</span> <span class="string">&quot;<span class="variable">$scheme</span><span class="variable">$request_method</span><span class="variable">$host</span>/<span class="variable">$resized_file</span>&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_revalidate</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> timeout updating http_500 http_503 http_404;</span><br><span class="line">            <span class="attribute">add_header</span> X-Cache-Status <span class="string">&quot;HIT&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果缓存中不存在，使用 image_filter 模块生成缩略图</span></span><br><span class="line">        <span class="attribute">if</span> (!-f <span class="variable">$request_filename</span>-<span class="variable">$arg_w</span>-<span class="variable">$arg_h</span><span class="variable">$arg_crop</span>.<span class="variable">$image_extension</span>) &#123;</span><br><span class="line">            <span class="attribute">image_filter</span> resize <span class="variable">$arg_w</span> <span class="variable">$arg_h</span>;</span><br><span class="line">           </span><br><span class="line">        <span class="attribute">image_filter</span> crop <span class="variable">$arg_w</span> <span class="variable">$arg_h</span> <span class="variable">$arg_x</span> <span class="variable">$arg_y</span>;</span><br><span class="line">        <span class="attribute">image_filter_jpeg_quality</span> <span class="number">75</span>;</span><br><span class="line">        <span class="attribute">image_filter_buffer</span> <span class="number">20M</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_pragma</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_revalidate</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_valid</span> <span class="number">60m</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_lock</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_lock_age</span> <span class="number">5s</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> timeout updating http_500 http_503 http_404;</span><br><span class="line">        <span class="attribute">add_header</span> X-Cache-Status <span class="string">&quot;MISS&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果缩略图生成成功，将其存储到磁盘</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$image_filtering</span>) &#123;</span><br><span class="line">            <span class="attribute">add_header</span> X-Cache-Status <span class="string">&quot;GENERATED&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_pragma</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_revalidate</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">60m</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_lock</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_lock_age</span> <span class="number">5s</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_use_stale</span> <span class="literal">error</span> timeout updating http_500 http_503 http_404;</span><br><span class="line">            <span class="attribute">try_files</span> /thumbnails/<span class="variable">$resized_file</span> /dev/null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Shawshank-c</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/03/13/Fastdfs%E9%83%A8%E7%BD%B2/">http://example.com/2024/03/13/Fastdfs%E9%83%A8%E7%BD%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Shawshank-c</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/13/JUC/1%20valatile%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/" title="volatile是什么？"><img class="cover" src="https://i.loli.net/2019/11/10/lP3rLNUBaGtSVzc.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">volatile是什么？</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/13/SpringBoot+Elasticsearch+ik/" title="SpringBoot+Elasticsearch+ik实战"><img class="cover" src="https://i.loli.net/2019/11/10/53eTB2uiNRlXwFP.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot+Elasticsearch+ik实战</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://shuichang.oss-cn-beijing.aliyuncs.com/A401B334-D883-4704-8016-2B664F7B9C62.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Shawshank-c</div><div class="author-info__description">hello I'm Shawshank-c</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-%E5%AE%89%E8%A3%85Fastdfs"><span class="toc-number">1.</span> <span class="toc-text">docker 安装Fastdfs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85FastDFS"><span class="toc-number">1.1.</span> <span class="toc-text">1.安装FastDFS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 镜像下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 创建目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%BC%80%E5%90%AFtracker%E5%AE%B9%E5%99%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 开启tracker容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E5%BC%80%E5%90%AFstorage%E5%AE%B9%E5%99%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4 开启storage容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-FastDFS%E9%9B%86%E6%88%90Nginx-lua-GraphicMagick"><span class="toc-number">1.2.</span> <span class="toc-text">2. FastDFS集成Nginx+lua+GraphicMagick</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E4%BE%9D%E8%B5%96%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 依赖下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%9F%BA%E7%A1%80%E5%8C%85"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 安装软件基础包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">2.3 依赖安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E4%BF%AE%E6%94%B9nginx-conf%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.4 修改nginx.conf配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Storage%E9%85%8D%E7%BD%AE%E5%A4%9A%E8%B7%AF%E5%BE%84"><span class="toc-number">1.4.</span> <span class="toc-text">3. Storage配置多路径</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E4%BF%AE%E6%94%B9-storage-conf"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 修改 storage.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E4%BF%AE%E6%94%B9mod-fastdfs-conf"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 修改mod_fastdfs.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AE%E5%A4%9A%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9-storage"><span class="toc-number">1.5.</span> <span class="toc-text">4. 配置多存储节点(storage)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E4%BF%AE%E6%94%B9-storage1-mod-fastdfs-conf"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 修改 storage1 mod_fastdfs.conf&#96;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E4%BF%AE%E6%94%B9-storage2-storage-conf"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 修改 storage2 storage.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BF%AE%E6%94%B9storage%E8%8A%82%E7%82%B9%E7%BA%BF%E7%A8%8B%E5%A4%84%E7%90%86%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">5. 修改storage节点线程处理数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E8%A7%A3%E5%86%B3%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">1.7.</span> <span class="toc-text">6.解决文件访问权限</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/04/18/daily-record/" title="daily record"><img src="https://i.loli.net/2019/11/10/lP3rLNUBaGtSVzc.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="daily record"/></a><div class="content"><a class="title" href="/2024/04/18/daily-record/" title="daily record">daily record</a><time datetime="2024-04-18T08:27:44.000Z" title="发表于 2024-04-18 16:27:44">2024-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/13/hello-world/" title="Hello World"><img src="https://i.loli.net/2019/11/10/53eTB2uiNRlXwFP.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"/></a><div class="content"><a class="title" href="/2024/03/13/hello-world/" title="Hello World">Hello World</a><time datetime="2024-03-13T07:58:54.051Z" title="发表于 2024-03-13 15:58:54">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/13/JUC/4%20java%E9%94%81/" title="Java锁"><img src="https://i.loli.net/2019/11/10/lP3rLNUBaGtSVzc.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java锁"/></a><div class="content"><a class="title" href="/2024/03/13/JUC/4%20java%E9%94%81/" title="Java锁">Java锁</a><time datetime="2024-03-13T05:39:56.000Z" title="发表于 2024-03-13 13:39:56">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/13/JUC/3.%E9%9B%86%E5%90%88%E7%B1%BB%E4%B8%8D%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" title="集合类不安全问题"><img src="https://i.loli.net/2019/11/10/53eTB2uiNRlXwFP.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="集合类不安全问题"/></a><div class="content"><a class="title" href="/2024/03/13/JUC/3.%E9%9B%86%E5%90%88%E7%B1%BB%E4%B8%8D%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" title="集合类不安全问题">集合类不安全问题</a><time datetime="2024-03-13T05:38:56.000Z" title="发表于 2024-03-13 13:38:56">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/13/JUC/1%20valatile%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/" title="volatile是什么？"><img src="https://i.loli.net/2019/11/10/lP3rLNUBaGtSVzc.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="volatile是什么？"/></a><div class="content"><a class="title" href="/2024/03/13/JUC/1%20valatile%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/" title="volatile是什么？">volatile是什么？</a><time datetime="2024-03-13T05:36:56.000Z" title="发表于 2024-03-13 13:36:56">2024-03-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Shawshank-c</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>